# AV女優レコメンドサービス　AVzeusのアルゴリズム実装

## 0.各リンク先
- β版サイトURL https://avzeus-client.mmu6fa6rgrojg.ap-northeast-1.cs.amazonlightsail.com/
- Backend https://github.com/souhub/avzeus-backend
- Frontend https://github.com/souhub/avzeus-frontend

## 1.pytorch-facenetとseleniumを使った画像収集
AV女優さんの名簿を作りseleniumを使って　[名前　画像]　と検索してでてきた画像を上からpytorch-facenetのMTCNNにかけて160×160の顔部分の画像を切り出します。これを一人の女優さんに対して50枚集めて女優さんごとにディレクトリを作って保存します。この時点では顔ではなかったり他の人の顔の写真が含まれています。

## 2.不要な画像の除去
1つの女優さんのディレクトリに入っている50枚の画像をpytorch-facenetのInceptionResnetを使って512次元のベクトルにします。次に1つのベクトルに対して他の49枚の画像とのcos類似度の平均値を求めその数値が0.9以下の画像は削除しました。あとで削除された画像を見ると男の人だったりそもそも顔でなかったりとうまくいったようです。

## 3.女優さんのグループ分け　代表ベクトルrp_vec
不要な画像を消去したので残ってる画像のベクトルの平均をとりベクトルと女優さんが1対1に対応するようにします。これら女優さんの人数個のベクトルをK-meansで9個のグループに分けます。9個なのは携帯画面にほ表示した時におさまりが良さそうだったからです。(エルボー法で良さげなグループ数を求めようと思いましたが大差ありませんでした。） そしてあるグループ内のベクトルたちに対してその平均を求めます。これら9つのベクトルはそのグループを代表するという意味でrepresentative vectorと名づけrp_vecと表記します。

## 4.代表女優さんとレコメンド
作った9つのグループを代表する女優さんを決めてその中から女優さんを5人順位をつけて選んでもらうのを想定しているのでその表示する女優さんを選ばなければいけません。その女優さんはそのグループを代表するような顔であってほしいので、3で定義したrp_vecとグループ内でもっともcos類似度が大きい女優さんを選びました。代表女優さんと呼ぶことにします。顔の系統がいい感じにばらけたように感じます。レコメンドの際にはこれら9つの代表女優さんから5人を順位をつけて選んでもらいその代表女優さんが所属するグループのrp_vec5つと全女優のcos類似度をとりそれらを足し合わせてその数値が大きい順にレコメンドすれば良いですが、それではユーザーさんの順位づけが考慮されていないので何か重みをかけて足し合わせたいのでその係数を強化学習を使って出力させることにしました。

## 5.重み係数を出力する連続制御A2C
連続制御A2Cで係数を4つ出力（1位のrp_vecとのcos類似度は補正なし)させます。(具体的にはガウス分布の平均と分散を出力) それには環境と即時報酬を定義する必要があります。環境は変数10個で1位のrp_vecと2,3,4,5位のrp_vecとの距離、2位のrp_vecと3,4,5位のrp_vecとの距離、3位のrp_vecと4,5位のrp_vecとの距離、4位のrp_vecと5位のrp_vecとの距離です。これだと女優さんを新しく追加してrp_vecが変わったとしてもおなじネットワークで対応できると考えました。即時報酬はレコメンドした女優さんの中でi番目がクリックされたときr=(-i+1)/10としました。これでネットワークはrを最大化つまりiを最小化、レコメンド精度の上昇につながると考えました。

## 6.重み係数の最大値
A2Cでレコメンド精度を向上させられるはずではありますがこれでは初期状態で1以上の重みがかけられたりする可能性があり、そうなると初期ではサービスとして便利なものになりません。なのでA2Cが出力した4つの数値にsigmoid関数を通した上で2,3,4,5位それぞれ対応する重みに[0.9,0.7,0.5,0.3]をかけてA2Cの更新時はこの変換を考慮してlossを計算します。こうすればネットワークが初期であってもある程度のレコメンドになるはずです。

## 7.備考

- ACERを使えば経験再生が使えるらしいのである程度データを貯めてそこから重みを実際にレコメンドに使うというようなことができるなと思った。
- ユーザーに画像をアップロードしてもらいその画像をMTCNNで切り取りベクトル化、9つのrp_vecとのcos類似度を計算し大きい順に5つ選ぶ。あとは上のアルゴリズムでレコメンドすることで、ユーザーが任意の好みの顔画像からAV女優を探すことができるというのを実装中
- 図が入ればもう少し分かりやすいかもしれません、すいません
